WebDKP_TierInterval=50;WebDKP_Filters={["Death Knight"]=1,["Druid"]=1,["Hunter"]=1,["Mage"]=1,["Rogue"]=1,["Shaman"]=1,["Paladin"]=1,["Priest"]=1,["Warrior"]=1,["Warlock"]=1,["Group"]=1,["Guild"]=1,["GuildOnline"]=1,["LimitAlts"]=0,["LimitAlts2"]=0,["Standby1"]=0,["Standby2"]=0}WebDKP_FilterGroups={["Casters"]="Paladin Shaman Mage Warlock Priest Druid",["Melee"]="Paladin Shaman Warrior Rogue Druid Hunter Death Knight",["Healer"]="Shaman Paladin Priest Druid",["Chain"]="Shaman Hunter",["Cloth"]="Warlock Mage Priest",["Leather"]="Rogue Druid",["Plate"]="Warrior Paladin Death Knight"}WebDKP_IgnoreItems={"源质矿石","连结水晶"}WebDKP_DkpTable={}WebDKP_Loot={}WebDKP_Synch_Users={}WebDKP_RaidInfo={}WebDKP_Ignored_Items={}WebDKP_Tables={}selectedTableid=1;WebDKP_DkpTableToShow={}WebDKP_PlayersInGroup={}WebDKP_LogSort={["curr"]=3,["way"]=1,["curr2"]=2,["way2"]=1,["curr3"]=1,["way3"]=2,["curr4"]=4,["way4"]=1}WebDKP_Options={["EPGPEnabled"]=0,["AutoGive"]=0,["AwardBossDKP"]=0,["BossDKPMCAndOLValue"]=0,["BossDKPBWLValue"]=0,["BossDKPTAQValue"]=0,["BossDKPNAXXValue"]=0,["ZeroSumStandby"]=1,["TimedStandby"]=1,["AutofillEnabled"]=1,["AutofillThreshold"]=3,["AutoAwardEnabled"]=1,["SelectedTableId"]=1,["MiniMapButtonAngle"]=1,["BidAnnounceRaid"]=0,["BidConfirmPopup"]=1,["BidAllowNegativeBids"]=0,["BidFixedBidding"]=0,["BidNotifyLowBids"]=0,["TimedAwardRepeat"]=1,["TimedAwardInProgress"]=false,["TimedAwardTimer"]=0,["TimedAwardTotalTime"]=5,["TimedAwardDkp"]=0,["SynchPassword"]="",["EnableSynch"]=0,["SynchFrom"]="",["Decay"]=1,["TurnBase"]=1,["SilentBidding"]=1,["BidandRoll"]=0,["FiftyGreed"]=0,["NeedAll"]=0,["DisableBid"]=0,["TimedAwardMiniTimer"]=0,["Enabled"]=1,["Announcements"]=0,["EditStartAnnounce"]="",["EditDuringAnnounce"]="",["EditEndAnnounce"]="",["EditSRollAnnounce"]="",["EditRollAnnounce"]="",["EditERollAnnounce"]="",["InGroup"]=1,["LimitGuild"]=1,["LimitGuildOnline"]=1,["LimitAlts"]=0,["LimitAlts2"]=0,["Standby1"]=0,["Standby2"]=0,["StartBid"]=0,["Time"]=0,["AltClick"]=1,["IgnWhispers"]=0,["GreedDKP"]="50",["NeedDKP"]="100",["dkpCap"]=0,["dkpCapLimit"]=0,["ItemLevelEquation"]=0,["ItemLevelMult"]=".01",["SlotLocMult"]=0,["ItemLocMult"]={["head"]="1",["neck"]="1",["shoulders"]="1",["back"]="1",["chest"]="1",["wrist"]="1",["hands"]="1",["waist"]="1",["legs"]="1",["feet"]="1",["fingers"]="1",["trinkets"]="1",["mainhand"]="1",["shield"]="1",["ranged"]="1",["relic"]="1",["idol"]="1",["twohand"]="1",["onehanders"]="1",["heldoffhand"]="1",["offhandweapon"]="1"}}WebDKP_WebOptions={["ZeroSumEnabled"]=0,["CombineAlts"]=0}WebDKP_Alts={}local a=false;local b=WebDKP_sign;SG=""function WebDKP_OnLoad(self)local c=self;if a==false then a=true;SlashCmdList["WEBDKP"]=WebDKP_ToggleGUI;SLASH_WEBDKP1="/webdkp"SLASH_SYNCH1="/synch"SlashCmdList["SYNCH"]=WebDKP_Start_Synch;c:RegisterEvent("CHAT_MSG_SYSTEM")c:RegisterEvent("COMBAT_LOG_EVENT_UNFILTERED")c:RegisterEvent("CHAT_MSG_MONSTER_YELL")c:RegisterEvent("GROUP_ROSTER_UPDATE")c:RegisterEvent("RAID_ROSTER_UPDATE")c:RegisterEvent("ITEM_TEXT_READY")c:RegisterEvent("ADDON_LOADED")c:RegisterEvent("CHAT_MSG_WHISPER")c:RegisterEvent("CHAT_MSG_LOOT")c:RegisterEvent("CHAT_MSG_PARTY")c:RegisterEvent("CHAT_MSG_RAID")c:RegisterEvent("CHAT_MSG_RAID_LEADER")c:RegisterEvent("CHAT_MSG_RAID_WARNING")c:RegisterEvent("ADDON_ACTION_FORBIDDEN")c:RegisterEvent("COMBAT_LOG_EVENT")c:RegisterEvent("CHAT_MSG_ADDON")WebDKP_OnEnable()end end;function WebDKP_OnEnable()_G["RivendareFlag"]=0;_G["LadyFlag"]=0;_G["SirFlag"]=0;_G["KorFlag"]=0;_G["Earthbreaker"]=0;_G["WaveBinder"]=0;_G["AwardedReason"]=""_G["AwardedDate"]=""_G["LineLocation"]=""_G["WebDKP_FiltersFrame"]:Show()_G["WebDKP_AwardDKP_Frame"]:Hide()_G["WebDKP_AwardItem_Frame"]:Hide()_G["WebDKP_Standby_Frame"]:Hide()WebDKP_UpdatePlayersInGroup()WebDKP_UpdateTableToShow()WebDKP_Register_WhisperHook()hooksecurefunc("SetItemRef",WebDKP_ItemChatClick)hooksecurefunc("ChatFrame_OnHyperlinkShow",WebDKP_ItemChatShiftClick)hooksecurefunc("HandleModifiedItemClick",WebDKP_HandleModifiedItemClick)WebDKP_Tab_OnClick(nil)end;function WebDKP_OnEvent(self,d,...)local e,f,g,h,i,j,k,l,m=...if d=="GROUP_ROSTER_UPDATE"then WebDKP_RAID_ROSTER_UPDATE(e)elseif d=="PARTY_MEMBERS_CHANGED"then WebDKP_PARTY_MEMBERS_CHANGED(e)elseif d=="ADDON_LOADED"then WebDKP_ADDON_LOADED(e)elseif d=="CHAT_MSG_SYSTEM"then Webdkp_Sys_Msg_Received(e)elseif d=="CHAT_MSG_ADDON"then if C_ChatInfo.IsAddonMessagePrefixRegistered("!WDKPA Undo")==false then C_ChatInfo.RegisterAddonMessagePrefix("!WDKPA Undo")elseif C_ChatInfo.IsAddonMessagePrefixRegistered("!WDKPA LogAdd")==false then C_ChatInfo.RegisterAddonMessagePrefix("!WDKPA LogAdd")elseif C_ChatInfo.IsAddonMessagePrefixRegistered("!WDKPA LogDel")==false then C_ChatInfo.RegisterAddonMessagePrefix("!WDKPA LogDel")elseif C_ChatInfo.IsAddonMessagePrefixRegistered("!WDKPA Item")==false then C_ChatInfo.RegisterAddonMessagePrefix("!WDKPA Item")elseif C_ChatInfo.IsAddonMessagePrefixRegistered("!WDKP MultStart")==false then C_ChatInfo.RegisterAddonMessagePrefix("!WDKP Mult Start")elseif C_ChatInfo.IsAddonMessagePrefixRegistered("!WDKP MultName")==false then C_ChatInfo.RegisterAddonMessagePrefix("!WDKP MultName")elseif C_ChatInfo.IsAddonMessagePrefixRegistered("!WDKP Mult End")==false then C_ChatInfo.RegisterAddonMessagePrefix("!WDKP Mult End")end;WebDKP_AddonChan_Processing(e,f,g,h)end;if WebDKP_Options["Enabled"]==1 then if d=="CHAT_MSG_WHISPER"then WebDKP_CHAT_MSG_WHISPER(e,i)elseif d=="CHAT_MSG_PARTY"or d=="CHAT_MSG_RAID"or d=="CHAT_MSG_RAID_LEADER"or d=="CHAT_MSG_RAID_WARNING"then WebDKP_CHAT_MSG_PARTY_RAID(e,i)elseif d=="CHAT_MSG_LOOT"then WebDKP_Loot_Taken(e,i)elseif d=="ADDON_ACTION_FORBIDDEN"then WebDKP_Print(e.."  "..i)elseif d=="COMBAT_LOG_EVENT_UNFILTERED"then local n,o,_,p,q,r,s,t,u,v,w=CombatLogGetCurrentEventInfo()WebDKP_BossAward_PerformAward(nil,o,u)elseif d=="CHAT_MSG_MONSTER_YELL"then WebDKP_BossAward_PerformAward(e,f,nil)end end end;function WebDKP_ADDON_LOADED(e)if e=="WebDKP"then local x=b.new()x:update(_G["WebDKP_Frame".."Website".."Label"]:GetText())if WebDKP_DkpTable==nil then WebDKP_DkpTable={}end;if WebDKP_Loot==nil then WebDKP_Loot={}end;if WebDKP_Synch_Users==nil then WebDKP_Synch_Users={}end;if WebDKP_Ignored_Items==nil then WebDKP_Ignored_Items={}end;if WebDKP_RaidInfo==nil then WebDKP_RaidInfo={}end;WebDKP_Standby_Reset()numEntries1=getn(WebDKP_IgnoreItems)numEntries2=getn(WebDKP_Ignored_Items)for y=1,numEntries2,1 do itemfoundflag=0;newitemignored=WebDKP_Ignored_Items[y]for z=1,numEntries1,1 do ItemIgnoredName=WebDKP_IgnoreItems[z]if ItemIgnoredName==newitemignored then itemfoundflag=1 end end;if itemfoundflag==0 then numEntries1=numEntries1+1;tinsert(WebDKP_IgnoreItems,newitemignored)end end;local A=false;if WebDKP_Tables~=nil and next(WebDKP_Tables)~=nil then for B,C in pairs(WebDKP_Tables)do if type(C)=="table"then A=WebDKP_Options["SelectedTableId"]==C["id"]if A then break end end end end;if not A then WebDKP_Options["SelectedTableId"]=1 end;WebDKP_Frame.selectedTableid=WebDKP_Options["SelectedTableId"]WebDKP_Options_Init()WebDKP_UpdateTableToShow()if WebDKP_Options["EPGPEnabled"]==0 then WebDKP_UpdateTable()else WebDKP_UpdateEPGPTable()end;WebDKP_UpdateLogTable()WebDKP_MinimapButton_SetPositionAngle(WebDKP_Options["MiniMapButtonAngle"])x:update(tostring(WebDKP_WebOptions["User"]))x:update(tostring(WebDKP_WebOptions["AddonVersion"]))local D;for E,F in pairs(WebDKP_Tables)do if F["id"]==1 then D=E end end;x:update(tostring(D))SG=b.tohex(x:finish())end end;function WebDKP_OnDisable()end;function WebDKP_ToggleGUI(G,H)local I=0;local J=G;if string.find(J,"ignore")==1 and string.find(J,"list")==8 then local K=UnitName("player")numEntries=getn(WebDKP_Ignored_Items)SendChatMessage("WebDKP: User Defined Ignored Items:","WHISPER",nil,K)for z=1,numEntries,1 do itemignored=WebDKP_Ignored_Items[z]SendChatMessage("WebDKP: Item Ignored ="..itemignored,"WHISPER",nil,K)end end;if string.find(J,"ignore")==1 and string.find(J,"add")==8 then nameofitem=string.gsub(J,"ignore add ","")if nameofitem~=nil and nameofitem~=""then tinsert(WebDKP_IgnoreItems,nameofitem)tinsert(WebDKP_Ignored_Items,nameofitem)end end;if string.find(J,"ignore")==1 and string.find(J,"del")==8 then nameofitem=string.gsub(J,"ignore del ","")if nameofitem~=nil and nameofitem~=""then numEntries1=getn(WebDKP_IgnoreItems)for z=1,numEntries1,1 do local L=WebDKP_IgnoreItems[z]if L==nameofitem then tremove(WebDKP_IgnoreItems,z)end end;numEntries2=getn(WebDKP_Ignored_Items)for z=1,numEntries2,1 do local L=WebDKP_Ignored_Items[z]if L==nameofitem then tremove(WebDKP_Ignored_Items,z)end end end end;if string.find(J,"show")==1 and string.find(J,"table")==6 then if WebDKP_Frame:IsShown()then WebDKP_Frame:Hide()else if WebDKP_Options["EPGPEnabled"]==1 then WebDKP_Frame:Show()WebDKP_FrameScrollFrame:Hide()WebDKP_FrameName:Hide()WebDKP_FrameClass:Hide()WebDKP_FrameDKP:Hide()WebDKP_FrameGuildRank:Hide()for z=1,22,1 do local M=getglobal("WebDKP_FrameLine"..z)M:Hide()end;WebDKP_FrameScrollFrameEPGP:Show()WebDKP_FrameNameEPGP:Show()WebDKP_FrameClassEPGP:Show()WebDKP_FrameEP:Show()WebDKP_FrameGP:Show()WebDKP_FrameLP:Show()WebDKP_FrameGuildRankEPGP:Show()for z=1,22,1 do local M=getglobal("WebDKP_FrameLineEPGP"..z)M:Show()end else WebDKP_Frame:Show()WebDKP_FrameScrollFrameEPGP:Hide()WebDKP_FrameScrollFrame:Show()WebDKP_FrameName:Show()WebDKP_FrameClass:Show()WebDKP_FrameDKP:Show()WebDKP_FrameGuildRank:Show()for z=1,22,1 do local M=getglobal("WebDKP_FrameLine"..z)M:Show()end;WebDKP_FrameNameEPGP:Hide()WebDKP_FrameClassEPGP:Hide()WebDKP_FrameEP:Hide()WebDKP_FrameGP:Hide()WebDKP_FrameLP:Hide()WebDKP_FrameGuildRankEPGP:Hide()for z=1,22,1 do local M=getglobal("WebDKP_FrameLineEPGP"..z)M:Hide()end end;WebDKP_Tables_DropDown_OnLoad()end end;if string.find(J,"show")==1 and string.find(J,"bidding")==6 then if WebDKP_BidFrame:IsShown()then WebDKP_BidFrame:Hide()else WebDKP_BidFrame:Show()end end;if string.find(J,"show")==1 and string.find(J,"synch")==6 then if WebDKP_SynchFrame:IsShown()then WebDKP_SynchFrame:Hide()else WebDKP_SynchFrame:Show()end end;if string.find(J,"show")==1 and string.find(J,"options")==6 then if WebDKP_OptionsFrame:IsShown()then WebDKP_OptionsFrame:Hide()else WebDKP_OptionsFrame:Show()end end;if string.find(J,"show")==1 and string.find(J,"timed")==6 then if WebDKP_TimedAwardFrame:IsShown()then WebDKP_TimedAwardFrame:Hide()else WebDKP_TimedAwardFrame:Show()end end;if string.find(J,"show")==1 and string.find(J,"help")==6 then if WebDKP_HelpFrame:IsShown()then WebDKP_HelpFrame:Hide()else WebDKP_HelpFrame:Show()end end;if string.find(J,"show")==1 and string.find(J,"log")==6 then if WebDKP_LogFrame:IsShown()then WebDKP_LogFrame:Hide()else WebDKP_LogFrame:Show()end end;if string.find(J,"show")==1 and string.find(J,"raidlog")==6 then if WebDKP_RaidInfoFrame:IsShown()then WebDKP_RaidInfoFrame:Hide()else WebDKP_RaidInfoFrame:Show()end end;if string.find(J,"show")==1 and string.find(J,"charlog")==6 then if WebDKP_CharRaidInfoFrame:IsShown()then WebDKP_CharRaidInfoFrame:Hide()else WebDKP_CharRaidInfoFrame:Show()end end;if string.find(J,"start")==1 and string.find(J,"raid")==7 then WebDKP_RaidStart()end;if string.find(J,"end")==1 and string.find(J,"raid")==5 then WebDKP_RaidEnd()end end;function WebDKP_Table_GUI()if WebDKP_Frame:IsShown()then WebDKP_Frame:Hide()else if WebDKP_Options["EPGPEnabled"]==1 then WebDKP_Frame:Show()WebDKP_FrameScrollFrame:Hide()WebDKP_FrameName:Hide()WebDKP_FrameClass:Hide()WebDKP_FrameDKP:Hide()WebDKP_FrameGuildRank:Hide()for z=1,22,1 do local M=getglobal("WebDKP_FrameLine"..z)M:Hide()end;WebDKP_FrameScrollFrameEPGP:Show()WebDKP_FrameNameEPGP:Show()WebDKP_FrameClassEPGP:Show()WebDKP_FrameEP:Show()WebDKP_FrameGP:Show()WebDKP_FrameLP:Show()WebDKP_FrameGuildRankEPGP:Show()for z=1,22,1 do local M=getglobal("WebDKP_FrameLineEPGP"..z)M:Show()end else WebDKP_Frame:Show()WebDKP_FrameScrollFrame:Show()WebDKP_FrameName:Show()WebDKP_FrameClass:Show()WebDKP_FrameDKP:Show()WebDKP_FrameGuildRank:Show()for z=1,22,1 do local M=getglobal("WebDKP_FrameLine"..z)M:Show()end;WebDKP_FrameScrollFrameEPGP:Hide()WebDKP_FrameNameEPGP:Hide()WebDKP_FrameClassEPGP:Hide()WebDKP_FrameEP:Hide()WebDKP_FrameGP:Hide()WebDKP_FrameLP:Hide()WebDKP_FrameGuildRankEPGP:Hide()for z=1,22,1 do local M=getglobal("WebDKP_FrameLineEPGP"..z)M:Hide()end end;WebDKP_Tables_DropDown_OnLoad()end end;function WebDKP_OPEN_MASTER_LOOT_LIST()end;function WebDKP_PARTY_MEMBERS_CHANGED()WebDKP_UpdatePlayersInGroup()WebDKP_UpdateTableToShow()if WebDKP_Options["EPGPEnabled"]==0 then WebDKP_UpdateTable()else WebDKP_UpdateEPGPTable()end end;function WebDKP_RAID_ROSTER_UPDATE()WebDKP_UpdatePlayersInGroup()WebDKP_UpdateTableToShow()if WebDKP_Options["EPGPEnabled"]==0 then WebDKP_UpdateTable()else WebDKP_UpdateEPGPTable()end end;function WebDKP_CHAT_MSG_WHISPER(e,f)local N=WebDKP_Options["IgnWhispers"]local O=0;if N==1 then local name=f;if WebDKP_PlayerInGroup(name)==false then O=1 end end;if O==0 then WebDKP_WhisperDKP_Event(e,f)WebDKP_Bid_Event(e,f)WebDKP_Synch_Processing(e,f)end end;function WebDKP_CHAT_MSG_PARTY_RAID(e,f)WebDKP_Bid_Event(e,f)end;function WebDKP_Refresh()WebDKP_UpdatePlayersInGroup()WebDKP_UpdateTableToShow()if WebDKP_Options["EPGPEnabled"]==0 then WebDKP_UpdateTable()else WebDKP_UpdateEPGPTable()end end;function WebDKP_Tab_OnClick(self)local c=self;if not c then c=WebDKP_FrameTab1 else PlaySound(841)end;tabs={["WebDKP_FiltersFrame"]=WebDKP_FrameTab1,["WebDKP_AwardDKP_Frame"]=WebDKP_FrameTab2,["WebDKP_AwardItem_Frame"]=WebDKP_FrameTab3,["WebDKP_Standby_Frame"]=WebDKP_FrameTab4}for E,F in pairs(tabs)do if F==c then PanelTemplates_SelectTab(F)_G[E]:Show()else PanelTemplates_DeselectTab(F)_G[E]:Hide()end end end;function WebDKP_SelectAll()local P=WebDKP_GetTableid()for E,F in pairs(WebDKP_DkpTable)do if type(F)=="table"then local Q=E;local R=F["class"]local S=F["dkp"..P]if S==nil then F["dkp"..P]=0;S=0 end;local T=floor((S-1)/WebDKP_TierInterval)if WebDKP_ShouldDisplay(Q,R,S,T)then WebDKP_DkpTable[Q]["Selected"]=true else WebDKP_DkpTable[Q]["Selected"]=false end end end;if WebDKP_Options["EPGPEnabled"]==0 then WebDKP_UpdateTable()else WebDKP_UpdateEPGPTable()end end;function WebDKP_UnselectAll()for E,F in pairs(WebDKP_DkpTable)do if type(F)=="table"then local Q=E;WebDKP_DkpTable[Q]["Selected"]=false end end;if WebDKP_Options["EPGPEnabled"]==0 then WebDKP_UpdateTable()else WebDKP_UpdateEPGPTable()end end;function WebDKP_UpdateFilterGroupsCheckedState()for B,U in pairs(WebDKP_FilterGroups)do if U~=nil then local V=_G["WebDKP_FiltersFrameClass"..B]if V~=nil then local W=WebDKP_AllFiltersOn(U)V:SetChecked(W==1)end end end end;function WebDKP_ReinforceCheckedFilterGroups()for B,U in pairs(WebDKP_FilterGroups)do if U~=nil then local V=_G["WebDKP_FiltersFrameClass"..B]if V~=nil then local X=V:GetChecked()if X==1 then WebDKP_SetFilterGroupState(U,1)end end end end end;function WebDKP_ToggleFilter(Y)WebDKP_Filters[Y]=abs(WebDKP_Filters[Y]-1)WebDKP_UpdateTableToShow()if WebDKP_Options["EPGPEnabled"]==0 then WebDKP_UpdateTable()else WebDKP_UpdateEPGPTable()end;WebDKP_UpdateFilterGroupsCheckedState()end;function WebDKP_CheckAllFilters()WebDKP_SetFilterState("Druid",1)WebDKP_SetFilterState("Hunter",1)WebDKP_SetFilterState("Mage",1)WebDKP_SetFilterState("Rogue",1)WebDKP_SetFilterState("Shaman",1)WebDKP_SetFilterState("Paladin",1)WebDKP_SetFilterState("Priest",1)WebDKP_SetFilterState("Warrior",1)WebDKP_SetFilterState("Warlock",1)WebDKP_SetFilterState("Death Knight",1)WebDKP_UpdateTableToShow()if WebDKP_Options["EPGPEnabled"]==0 then WebDKP_UpdateTable()else WebDKP_UpdateEPGPTable()end;WebDKP_UpdateFilterGroupsCheckedState()end;function WebDKP_UncheckAllFilters()WebDKP_SetFilterState("Druid",0)WebDKP_SetFilterState("Hunter",0)WebDKP_SetFilterState("Mage",0)WebDKP_SetFilterState("Rogue",0)WebDKP_SetFilterState("Shaman",0)WebDKP_SetFilterState("Paladin",0)WebDKP_SetFilterState("Priest",0)WebDKP_SetFilterState("Warrior",0)WebDKP_SetFilterState("Warlock",0)WebDKP_SetFilterState("Death Knight",0)WebDKP_UpdateTableToShow()if WebDKP_Options["EPGPEnabled"]==0 then WebDKP_UpdateTable()else WebDKP_UpdateEPGPTable()end;WebDKP_UpdateFilterGroupsCheckedState()end;function WebDKP_ToggleFilterGroup(Z)local a0=WebDKP_FilterGroups[Z]local V=_G["WebDKP_FiltersFrameClass"..Z]local X=V:GetChecked()if X then WebDKP_SetFilterGroupState(a0,1)else WebDKP_SetFilterGroupState(a0,0)end;WebDKP_UpdateTableToShow()if WebDKP_Options["EPGPEnabled"]==0 then WebDKP_UpdateTable()else WebDKP_UpdateEPGPTable()end;WebDKP_ReinforceCheckedFilterGroups()end;function WebDKP_AllFiltersOn(a0)local a1={}a1["Druid"]=string.find(string.lower(a0),"druid")a1["Hunter"]=string.find(string.lower(a0),"hunter")a1["Mage"]=string.find(string.lower(a0),"mage")a1["Rogue"]=string.find(string.lower(a0),"rogue")a1["Shaman"]=string.find(string.lower(a0),"shaman")a1["Paladin"]=string.find(string.lower(a0),"paladin")a1["Priest"]=string.find(string.lower(a0),"priest")a1["Warrior"]=string.find(string.lower(a0),"warrior")a1["Warlock"]=string.find(string.lower(a0),"warlock")a1["Death Knight"]=string.find(string.lower(a0),"death knight")local a2=true;for B,U in pairs(a1)do if U~=nil then if WebDKP_Filters[B]==0 then a2=false end end end;return a2 end;function WebDKP_SetFilterGroupState(a0,a3)local a1={}a1["Druid"]=string.find(string.lower(a0),"druid")a1["Hunter"]=string.find(string.lower(a0),"hunter")a1["Mage"]=string.find(string.lower(a0),"mage")a1["Rogue"]=string.find(string.lower(a0),"rogue")a1["Shaman"]=string.find(string.lower(a0),"shaman")a1["Paladin"]=string.find(string.lower(a0),"paladin")a1["Priest"]=string.find(string.lower(a0),"priest")a1["Warrior"]=string.find(string.lower(a0),"warrior")a1["Warlock"]=string.find(string.lower(a0),"warlock")a1["Death Knight"]=string.find(string.lower(a0),"death knight")for B,U in pairs(a1)do if U~=nil then WebDKP_SetFilterState(B,a3)end end end;function WebDKP_SetFilterState(a1,a3)xmlName=string.gsub(a1," ","_")local a4=_G["WebDKP_FiltersFrameClass"..xmlName]a4:SetChecked(a3==1)WebDKP_Filters[a1]=a3 end;function WebDPK2_SortBy(a5)if a5==5 then a5=6 end;if WebDKP_LogSort["curr"]==a5 then WebDKP_LogSort["way"]=abs(WebDKP_LogSort["way"]-1)else WebDKP_LogSort["curr"]=a5;if a5==1 then WebDKP_LogSort["way"]=0 elseif a5==2 then WebDKP_LogSort["way"]=0 elseif a5==3 then WebDKP_LogSort["way"]=1 else WebDKP_LogSort["way"]=1 end end;if WebDKP_Options["EPGPEnabled"]==0 then WebDKP_UpdateTable()else WebDKP_UpdateEPGPTable()end end;function WebDKP_HandleMouseOver(self)local c=self;local Q=_G[c:GetName().."Name"]:GetText()if Q~=nil and not WebDKP_DkpTable[Q]["Selected"]then _G[c:GetName().."Background"]:SetVertexColor(0.2,0.2,0.7,0.5)end end;function WebDKP_HandleMouseOverLog(self)local c=self;if WebDKP_Log~=nil then local a6=_G[c:GetName().."Date"]:GetText()local a7=_G[c:GetName().."Reason"]:GetText()local _,a8,a9=WebDKP_GetItemInfo(a7)a7=a8;if not WebDKP_Log[a7 .." "..a6]["selected"]then _G[c:GetName().."Background"]:SetVertexColor(0.2,0.2,0.7,0.5)end end end;function WebDKP_HandleMouseLeaveLog(self)local c=self;if WebDKP_Log~=nil then local a6=_G[c:GetName().."Date"]:GetText()local a7=_G[c:GetName().."Reason"]:GetText()local _,a8,a9=WebDKP_GetItemInfo(a7)a7=a8;if not WebDKP_Log[a7 .." "..a6]["selected"]then _G[c:GetName().."Background"]:SetVertexColor(0,0,0,0)end end end;function WebDKP_HandleMouseLeave(self)local c=self;local Q=_G[c:GetName().."Name"]:GetText()if Q~=nil and not WebDKP_DkpTable[Q]["Selected"]then _G[c:GetName().."Background"]:SetVertexColor(0,0,0,0)end end;function WebDKP_SelectPlayerToggle(self)local c=self;local Q=_G[c:GetName().."Name"]:GetText()if Q~=nil then if WebDKP_DkpTable[Q]["Selected"]then WebDKP_DkpTable[Q]["Selected"]=false;_G[c:GetName().."Background"]:SetVertexColor(0.2,0.2,0.7,0.5)else WebDKP_DkpTable[Q]["Selected"]=true;_G[c:GetName().."Background"]:SetVertexColor(0.1,0.1,0.9,0.8)end end end;function WebDKP_SelectLogToggle(self)local c=self;if WebDKP_Log~=nil then if _G["AwardedReason"]~=""and _G["AwardedDate"]~=""then WebDKP_Log[_G["AwardedReason"].." ".._G["AwardedDate"]]["selected"]=false end;if _G["LineLocation"]~=""then _G["LineLocation"]:SetVertexColor(0,0,0,0)end;local a6=_G[c:GetName().."Date"]:GetText()local a7=_G[c:GetName().."Reason"]:GetText()local _,a8,a9=WebDKP_GetItemInfo(a7)a7=a8;if WebDKP_Log[a7 .." "..a6]["selected"]then WebDKP_Log[a7 .." "..a6]["selected"]=false;_G[c:GetName().."Background"]:SetVertexColor(0.2,0.2,0.7,0.5)else WebDKP_Log[a7 .." "..a6]["selected"]=true;_G[c:GetName().."Background"]:SetVertexColor(0.1,0.1,0.9,0.8)end;_G["AwardedReason"]=a7;_G["AwardedDate"]=a6;_G["LineLocation"]=_G[c:GetName().."Background"]WebDKP_UpdateAwardedTable(a7,a6)end end;function WebDKP_Tables_DropDown_OnLoad()UIDropDownMenu_Initialize(WebDKP_Tables_DropDown,WebDKP_Tables_DropDown_Init)end;function WebDKP_Tables_DropDown_Init()if WebDKP_Frame.selectedTableid==nil then WebDKP_Frame.selectedTableid=1 end;local aa;local ab=""local ac={}for E,C in pairs(WebDKP_Tables)do local ad=C;ad["name"]=E;tinsert(ac,C)end;table.sort(ac,function(ae,af)return ae["id"]<af["id"]end)if ac~=nil and table.getn(ac)~=0 then for _,C in pairs(ac)do if type(C)=="table"then aa={}aa.text=C["name"]aa.value=C["id"]aa.func=WebDKP_Tables_DropDown_OnClick;if C["id"]==WebDKP_Frame.selectedTableid then aa.checked=C["id"]==WebDKP_Frame.selectedTableid;ab=aa.text end;UIDropDownMenu_AddButton(aa)end end end;UIDropDownMenu_SetSelectedName(WebDKP_Tables_DropDown,ab)UIDropDownMenu_SetWidth(WebDKP_Tables_DropDown,200,10)end;function WebDKP_Tables_DropDown_OnClick(self)local c=self;WebDKP_Frame.selectedTableid=c.value;WebDKP_Options["SelectedTableId"]=c.value;WebDKP_Tables_DropDown_Init()WebDKP_UpdateTableToShow()if WebDKP_Options["EPGPEnabled"]==0 then WebDKP_UpdateTable()else WebDKP_UpdateEPGPTable()end end;function WebDKP_MinimapButton_MouseDown(self)local c=self;local ag,ah=GetCursorPosition()ag=ag/c:GetEffectiveScale()ah=ah/c:GetEffectiveScale()WebDKP_MinimapButton.CursorStartX=ag;WebDKP_MinimapButton.CursorStartY=ah;local vCenterX,vCenterY=WebDKP_MinimapButton:GetCenter()local ai,aj=Minimap:GetCenter()WebDKP_MinimapButton.CenterStartX=vCenterX-ai;WebDKP_MinimapButton.CenterStartY=vCenterY-aj end;function WebDKP_MinimapButton_DragStart(self)WebDKP_MinimapButton.IsDragging=true;WebDKP_UpdateFrame:Show()end;function WebDKP_MinimapButton_DragEnd(self)WebDKP_MinimapButton.IsDragging=false;WebDKP_UpdateFrame:Hide()end;function WebDKP_MinimapButton_UpdateDragPosition(self)local c=self;local ag,ah=GetCursorPosition()ag=ag/c:GetEffectiveScale()ah=ah/c:GetEffectiveScale()local ak=ag-WebDKP_MinimapButton.CursorStartX;local al=ah-WebDKP_MinimapButton.CursorStartY;local vCenterX=WebDKP_MinimapButton.CenterStartX+ak;local vCenterY=WebDKP_MinimapButton.CenterStartY+al;local am=math.atan2(vCenterX,vCenterY)WebDKP_MinimapButton_SetPositionAngle(am)end;function WebDKP_RestrictAngle(an,ao,ap)if an==nil then return ao end;if ao==nil or ao==nil then return an end;if an<=ao or an>=ap then return an end;local aq=(an-ao)/(ap-ao)if aq>0.5 then return ap else return ao end end;function WebDKP_MinimapButton_SetPositionAngle(an)local am=an;local ar=nil;local as=nil;if GameTimeFrame:IsVisible()then if MinimapZoomIn:IsVisible()or MinimapZoomOut:IsVisible()then am=WebDKP_RestrictAngle(am,0.4302272732931596,2.930420793963121)else am=WebDKP_RestrictAngle(am,0.4302272732931596,1.720531504573905)end elseif MinimapZoomIn:IsVisible()or MinimapZoomOut:IsVisible()then am=WebDKP_RestrictAngle(am,1.720531504573905,2.930420793963121)end;am=WebDKP_RestrictAngle(am,-1.290357134304173,-0.4918423429923585)local at=80;vCenterX=math.sin(am)*at;vCenterY=math.cos(am)*at;WebDKP_MinimapButton:SetPoint("CENTER","Minimap","CENTER",vCenterX-1,vCenterY-1)WebDKP_Options["MiniMapButtonAngle"]=am end;function WebDKP_OnUpdate(self,au)if WebDKP_MinimapButton.IsDragging then WebDKP_MinimapButton_UpdateDragPosition(self)end end;function WebDKP_MinimapDropDown_OnLoad(self)local c=self;UIDropDownMenu_Initialize(c,WebDKP_MinimapDropDown_Initialize)end;function WebDKP_MinimapDropDown_Initialize()WebDKP_Add_MinimapDropDownItem(self,WebDKP.translations.WEBDKP_MINIMAPDROPDOWN_DKPTABLE,WebDKP_Table_GUI)WebDKP_Add_MinimapDropDownItem(self,WebDKP.translations.WEBDKP_MINIMAPDROPDOWN_BIDDING,WebDKP_Bid_ToggleUI)WebDKP_Add_MinimapDropDownItem(self,WebDKP.translations.WEBDKP_MINIMAPDROPDOWN_TIMEDAWARDS,WebDKP_TimedAward_ToggleUI)WebDKP_Add_MinimapDropDownItem(self,WebDKP.translations.WEBDKP_MINIMAPDROPDOWN_OPTIONS,WebDKP_Options_ToggleUI)WebDKP_Add_MinimapDropDownItem(self,WebDKP.translations.WEBDKP_MINIMAPDROPDOWN_HELP,WebDKP_Help_ToggleGUI)WebDKP_Add_MinimapDropDownItem(self,WebDKP.translations.WEBDKP_MINIMAPDROPDOWN_SYNCHSETTINGS,WebDKP_Synch_ToggleUI)WebDKP_Add_MinimapDropDownItem(self,WebDKP.translations.WEBDKP_MINIMAPDROPDOWN_VIEWLOG,WebDKP_Log_ToggleUI)WebDKP_Add_MinimapDropDownItem(self,WebDKP.translations.WEBDKP_MINIMAPDROPDOWN_RAIDLOG,WebDKP_RaidLog_ToggleUI)WebDKP_Add_MinimapDropDownItem(self,WebDKP.translations.WEBDKP_MINIMAPDROPDOWN_CHARRAIDLOG,WebDKP_CharRaidLog_ToggleUI)end;function WebDKP_Log_ToggleUI()if WebDKP_LogFrame:IsShown()then WebDKP_LogFrame:Hide()else WebDKP_LogFrame:Show()end end;function WebDKP_Add_MinimapDropDownItem(self,text,av)local c=self;local aa={}aa.text=text;aa.value=text;aa.owner=c;aa.func=av;UIDropDownMenu_AddButton(aa)end;function WebDKP_ItemChatClick(aw,text,ax)local ay=strfind(text,"player")if ay==nil then WebDKP_Bid_ItemChatClick(aw,text,ax)if IsShiftKeyDown()or IsControlKeyDown()then local _,a8,a9=WebDKP_GetItemInfo(aw)WebDKP_AwardItem_FrameItemName:SetText(a9)end;if IsAltKeyDown()and WebDKP_Options["AltClick"]==1 then local _,a8,a9=WebDKP_GetItemInfo(aw)WebDKP_BidFrameItem:SetText(a9)if WebDKP_BidFrame:IsShown()==FALSE then WebDKP_Bid_ToggleUI()end end end end;function WebDKP_HandleModifiedItemClick(az)if az==nil then return end;WebDKP_Bid_ItemChatClick(az,nil,nil)if IsShiftKeyDown()or IsControlKeyDown()then local aA,a8,a9=WebDKP_GetItemInfo(az)WebDKP_Bid_ItemChatClick(a9,a9,nil)WebDKP_AwardItem_FrameItemName:SetText(az)end;if IsAltKeyDown()and WebDKP_Options["AltClick"]==1 then local _,a8,a9=WebDKP_GetItemInfo(az)WebDKP_BidFrameItem:SetText(a9)if WebDKP_BidFrame:IsShown()==FALSE then WebDKP_Bid_ToggleUI()end end end;function WebDKP_ItemChatShiftClick(_,aw,text,ax)local ay=strfind(text,"player")if ay==nil then WebDKP_Bid_ItemChatClick(aw,text,ax)if IsShiftKeyDown()or IsControlKeyDown()then local _,a8,a9=WebDKP_GetItemInfo(aw)WebDKP_AwardItem_FrameItemName:SetText(a9)end;if IsAltKeyDown()then local _,a8,a9=WebDKP_GetItemInfo(aw)WebDKP_BidFrameItem:SetText(a9)if WebDKP_BidFrame:IsShown()==FALSE then WebDKP_Bid_ToggleUI()end end end end;function Webdkp_Sys_Msg_Received(e)local G=e;local aB=""local aC=WebDKP.translations.FORMAT_MSG_ROLLING_PATTERN;local aD,aE,aF,aG,aH,aI,aJ;if string.find(G,aC)then _,_,aD,aE,aF,aG=string.find(G,aC)WebDKP_ProcessRoll(aD,aE,aF,aG)end end;function WebDKP_Start_Synch()local aK=WebDKP_Options["SynchFrom"]local aL=WebDKP_Options["SynchPassword"]if aK~=nil and aK~=""then SendChatMessage("!Synch "..aL,"WHISPER",nil,aK)SendChatMessage("WebDKP: 同步的用户无效","WHISPER",nil,UnitName("player"))end end;function WebDKP_Start_SynchAll()local aK=WebDKP_Options["SynchFrom"]local aL=WebDKP_Options["SynchPassword"]SendChatMessage("!WDKP_Synch_All "..aL,"WHISPER",nil,aK)end;function WebDKP_UpdateLogTable()if WebDKP_Log~=nil then local aM={}local aN={}local aO=0;local aP=""for E,F in pairs(WebDKP_Log)do aP=""aO=0;if type(F)=="table"then if F["date"]~=nil and F["points"]~=nil and F["awarded"]~=nil and F["reason"]~=nil and F["foritem"]~=nil then aN=F["awarded"]for E,F in pairs(aN)do if type(F)=="table"then if F["name"]~=nil then aP=F["name"]aO=aO+1 end end end;if aO==1 then if F["foritem"]=="false"then reasonText=F["reason"]else reasonText=F["itemlink"]end;tinsert(aM,{F["date"],F["points"],reasonText,aP,F["foritem"]})end;if aO>1 then if F["foritem"]=="false"then reasonText=F["reason"]else reasonText=F["itemlink"]end;tinsert(aM,{F["date"],F["points"],reasonText,"多个玩家",F["foritem"]})end end end end;table.sort(aM,function(aQ,aR)if aQ and aR then if aQ==nil then return 1>0 elseif aR==nil then return 1<0 end;if WebDKP_LogSort["way2"]==1 then if aQ[WebDKP_LogSort["curr2"]]==aR[WebDKP_LogSort["curr2"]]then return aQ[1]>aR[1]else return aQ[WebDKP_LogSort["curr2"]]>aR[WebDKP_LogSort["curr2"]]end else if aQ[WebDKP_LogSort["curr2"]]==aR[WebDKP_LogSort["curr2"]]then return aQ[1]<aR[1]else return aQ[WebDKP_LogSort["curr2"]]<aR[WebDKP_LogSort["curr2"]]end end end end)local numEntries=getn(aM)local aS=FauxScrollFrame_GetOffset(WebDKP_LogFrameScrollLogFrame)FauxScrollFrame_Update(WebDKP_LogFrameScrollLogFrame,numEntries,23,20)for z=1,23,1 do local M=getglobal("WebDKP_LogFrameLine"..z)awardedText=getglobal("WebDKP_LogFrameLine"..z.."Awarded")local aT=getglobal("WebDKP_LogFrameLine"..z.."Amount")local reasonText=getglobal("WebDKP_LogFrameLine"..z.."Reason")local aU=getglobal("WebDKP_LogFrameLine"..z.."Date")local aV=z+FauxScrollFrame_GetOffset(WebDKP_LogFrameScrollLogFrame)if aV<=numEntries then M:Show()local charname=aM[aV][4]awardedText:SetText(charname)if WebDKP_DkpTable[charname]~=nil and WebDKP_DkpTable[charname]["class"]~=nil then local aW=WebDKP_DkpTable[charname]["class"]aW=string.upper(aW)aW=string.gsub(aW," ","")if RAID_CLASS_COLORS[aW]~=nil then awardedText:SetTextColor(RAID_CLASS_COLORS[aW]["r"],RAID_CLASS_COLORS[aW]["g"],RAID_CLASS_COLORS[aW]["b"])end end;aT:SetText(aM[aV][2])reasonText:SetText(aM[aV][3])aU:SetText(aM[aV][1])else M:Hide()end end end end;function WebDKP_UpdateAwardedTable(aX,aY)local aN={}nameentries={}if aX~=nil and aY~=nil then aN=WebDKP_Log[aX.." "..aY]["awarded"]for E,F in pairs(aN)do if type(F)=="table"then if F["name"]~=nil then tinsert(nameentries,{F["name"]})end end end end;table.sort(nameentries,function(aQ,aR)if aQ and aR then if aQ==nil then return 1>0 elseif aR==nil then return 1<0 end;if WebDKP_LogSort["way3"]==1 then if aQ[WebDKP_LogSort["curr3"]]==aR[WebDKP_LogSort["curr3"]]then return aQ[1]>aR[1]else return aQ[WebDKP_LogSort["curr3"]]>aR[WebDKP_LogSort["curr3"]]end else if aQ[WebDKP_LogSort["curr3"]]==aR[WebDKP_LogSort["curr3"]]then return aQ[1]<aR[1]else return aQ[WebDKP_LogSort["curr3"]]<aR[WebDKP_LogSort["curr3"]]end end end end)local numEntries=getn(nameentries)local aS=FauxScrollFrame_GetOffset(WebDKP_LogFrameScrollAwardedFrame)FauxScrollFrame_Update(WebDKP_LogFrameScrollAwardedFrame,numEntries,23,20)for z=1,23,1 do local M=getglobal("WebDKP_LogFrameLines"..z)awardedText=getglobal("WebDKP_LogFrameLines"..z.."Awarded")local aV=z+FauxScrollFrame_GetOffset(WebDKP_LogFrameScrollAwardedFrame)if aV<=numEntries then M:Show()local charname=nameentries[aV][1]awardedText:SetText(charname)if WebDKP_DkpTable[charname]~=nil and WebDKP_DkpTable[charname]["class"]~=nil then local aW=WebDKP_DkpTable[charname]["class"]aW=string.upper(aW)aW=string.gsub(aW," ","")if RAID_CLASS_COLORS[aW]~=nil then awardedText:SetTextColor(RAID_CLASS_COLORS[aW]["r"],RAID_CLASS_COLORS[aW]["g"],RAID_CLASS_COLORS[aW]["b"])end end else M:Hide()end end end;function WebDKP_ScrollLogAwardedToggle()WebDKP_UpdateAwardedTable(_G["AwardedReason"],_G["AwardedDate"])end;function WebDKP_LogUndo()if _G["AwardedReason"]~=""and _G["AwardedDate"]~=""then if WebDKP_Log[_G["AwardedReason"].." ".._G["AwardedDate"]]["awarded"]~=nil then if WebDKP_Options["EnableSynch"]==1 then WebDKP_Synch_Auto(points,"UNDO","",_G["AwardedReason"],_G["AwardedDate"])end;awardedtoremove=WebDKP_Log[_G["AwardedReason"].." ".._G["AwardedDate"]]["awarded"]tableidfrom=WebDKP_Log[_G["AwardedReason"].." ".._G["AwardedDate"]]["tableid"]local points=WebDKP_Log[_G["AwardedReason"].." ".._G["AwardedDate"]]["points"]local aX=WebDKP_Log[_G["AwardedReason"].." ".._G["AwardedDate"]]["reason"]local aZ=WebDKP_Log[_G["AwardedReason"].." ".._G["AwardedDate"]]["foritem"]points=tonumber(points)*-1;for E,F in pairs(awardedtoremove)do if type(F)=="table"then name=F["name"]if WebDKP_Options["EPGPEnabled"]==1 then if aZ=="false"then WebDKP_AddEPToTable(name,_,points,tableidfrom)WebDKP_UpdateTableToShow()WebDKP_UpdateEPGPTable()else WebDKP_AddGPToTable(name,_,points,tableidfrom)WebDKP_UpdateTableToShow()WebDKP_UpdateTable()end else WebDKP_AddDKPToTable(name,_,points,tableidfrom)WebDKP_UpdateTableToShow()WebDKP_UpdateTable()end end end;WebDKP_Log[_G["AwardedReason"].." ".._G["AwardedDate"]]=nil;_G["LineLocation"]:SetVertexColor(0,0,0,0)_G["LineLocation"]=""_G["AwardedReason"]=""_G["AwardedDate"]=""WebDKP_UpdateLogTable()end;for z=1,23,1 do local M=getglobal("WebDKP_LogFrameLines"..z)M:Hide()end;local numEntries=0;FauxScrollFrame_Update(WebDKP_LogFrameScrollAwardedFrame,numEntries,23,20)end end;function WebDKP_ScrollLogListToggle()WebDKP_UpdateLogTable()if WebDKP_Log~=nil then if _G["AwardedReason"]~=""and _G["AwardedDate"]~=""then WebDKP_Log[_G["AwardedReason"].." ".._G["AwardedDate"]]["selected"]=false end;if _G["LineLocation"]~=""then _G["LineLocation"]:SetVertexColor(0,0,0,0)end end end;function WebDKPLog_SortBy(a5)if WebDKP_LogSort["curr2"]==a5 then WebDKP_LogSort["way2"]=abs(WebDKP_LogSort["way2"]-1)else WebDKP_LogSort["curr2"]=a5;if a5==1 then WebDKP_LogSort["way2"]=0 elseif a5==2 then WebDKP_LogSort["way2"]=1 elseif a5==3 then WebDKP_LogSort["way2"]=0 else WebDKP_LogSort["way2"]=1 end end;WebDKP_UpdateLogTable()end;function WebDKPCharLog_SortBy(a5)if WebDKP_LogSort["curr4"]==a5 then WebDKP_LogSort["way4"]=abs(WebDKP_LogSort["way4"]-1)else WebDKP_LogSort["curr4"]=a5;if a5==1 then WebDKP_LogSort["way4"]=0 elseif a5==2 then WebDKP_LogSort["way4"]=1 elseif a5==3 then WebDKP_LogSort["way4"]=1 else WebDKP_LogSort["way4"]=1 end end end;function WebDKP_SelectAwardeeLogToggle(self)local c=self;if WebDKP_Log~=nil then if _G["LineLocation"]~=""then _G["LineLocation"]:SetVertexColor(0,0,0,0)end;local a_=_G[c:GetName().."Awarded"]:GetText()if a_~=nil then WebDKP_LogFrameCharChange:SetText(a_)end end end;function WebDKP_DeleteLogChar()local b0=WebDKP_LogFrameCharChange:GetText()local b1=0;if _G["AwardedReason"]~=""and _G["AwardedDate"]~=""then if WebDKP_Log[_G["AwardedReason"].." ".._G["AwardedDate"]]["awarded"]~=nil and b0~=""and b0~=nil then tableidfrom=WebDKP_Log[_G["AwardedReason"].." ".._G["AwardedDate"]]["tableid"]local points=WebDKP_Log[_G["AwardedReason"].." ".._G["AwardedDate"]]["points"]local aX=WebDKP_Log[_G["AwardedReason"].." ".._G["AwardedDate"]]["reason"]local aZ=WebDKP_Log[_G["AwardedReason"].." ".._G["AwardedDate"]]["foritem"]points=tonumber(points)*-1;local b2=WebDKP_Log[_G["AwardedReason"].." ".._G["AwardedDate"]]["awarded"]local numEntries=getn(b2)for E,F in pairs(b2)do if type(F)=="table"then if F["name"]~=nil then charname=F["name"]if charname==b0 then b1=1 end end end end;if b1==1 then if WebDKP_Options["EPGPEnabled"]==1 then if aZ=="false"then WebDKP_AddEPToTable(b0,_,points,tableidfrom)else WebDKP_AddGPToTable(b0,_,points,tableidfrom)end else WebDKP_AddDKPToTable(b0,_,points,tableidfrom)end;WebDKP_Log[_G["AwardedReason"].." ".._G["AwardedDate"]]["awarded"][b0]=nil;WebDKP_UpdateLogTable()numEntries=getn(b2)if numEntries==nil then WebDKP_Log[_G["AwardedReason"].." ".._G["AwardedDate"]]=nil;local M=getglobal("WebDKP_LogFrameLines"..1)M:Hide()else WebDKP_UpdateAwardedTable(_G["AwardedReason"],_G["AwardedDate"])end end;if WebDKP_Options["EnableSynch"]==1 then WebDKP_Synch_Auto(points,"LOGDEL",b0,_G["AwardedReason"],_G["AwardedDate"])end end end;WebDKP_UpdateTableToShow()if WebDKP_Options["EPGPEnabled"]==0 then WebDKP_UpdateTable()else WebDKP_UpdateEPGPTable()end end;function WebDKP_AddLogChar()local b3=WebDKP_LogFrameCharChange:GetText()local P=WebDKP_GetTableid()if _G["AwardedReason"]~=""and _G["AwardedDate"]~=""then if WebDKP_Log[_G["AwardedReason"].." ".._G["AwardedDate"]]["awarded"]~=nil and b3~=""and b3~=nil then tableidfrom=WebDKP_Log[_G["AwardedReason"].." ".._G["AwardedDate"]]["tableid"]local points=WebDKP_Log[_G["AwardedReason"].." ".._G["AwardedDate"]]["points"]local aX=WebDKP_Log[_G["AwardedReason"].." ".._G["AwardedDate"]]["reason"]local aZ=WebDKP_Log[_G["AwardedReason"].." ".._G["AwardedDate"]]["foritem"]points=tonumber(points)WebDKP_MakeSureInTable(b3,P,nil,nil)local b4=tonumber(WebDKP_Options["dkpCapLimit"])if WebDKP_DkpTable[b3]["dkp_"..P]+points>b4 and WebDKP_Options["EPGPEnabled"]==0 then WebDKP_Print("抱歉，无法将此玩家添加到此特定奖励.")PlaySound(847)else if WebDKP_Options["EPGPEnabled"]==1 then if aZ=="false"then WebDKP_AddEPToTable(b3,_,points,tableidfrom)else WebDKP_AddGPToTable(b3,_,points,tableidfrom)end else WebDKP_AddDKPToTable(b3,_,points,tableidfrom)end;WebDKP_Log[_G["AwardedReason"].." ".._G["AwardedDate"]]["awarded"][b3]={}WebDKP_Log[_G["AwardedReason"].." ".._G["AwardedDate"]]["awarded"][b3]["name"]=b3;WebDKP_Log[_G["AwardedReason"].." ".._G["AwardedDate"]]["awarded"][b3]["class"]=class;WebDKP_UpdateLogTable()if WebDKP_Options["EnableSynch"]==1 then WebDKP_Synch_Auto(points,"LOGADD",b3,_G["AwardedReason"],_G["AwardedDate"])end end end;WebDKP_UpdateAwardedTable(_G["AwardedReason"],_G["AwardedDate"])end;WebDKP_UpdateTableToShow()if WebDKP_Options["EPGPEnabled"]==0 then WebDKP_UpdateTable()else WebDKP_UpdateEPGPTable()end end;function WebDKP_ProcessItemSlotMulti(b5,itemlocation)if WebDKP_Options["ItemLocMult"]==nil then WebDKP_Options["ItemLocMult"]={}end;if WebDKP_Options["ItemLocMult"][itemlocation]==nil then WebDKP_Options["ItemLocMult"][itemlocation]="1"end;local b6=WebDKP_Options["ItemLocMult"][itemlocation]WebDKP_ItemSlotFrame:Show()WebDKP_ItemSlotFrameTitle:SetText(b5)WebDKP_ItemSlotFrameCost:SetText(b6)end;function WebDKP_SetItemSlotMulti(U,b5)if b5=="Head Slot"then itemlocation="head"elseif b5=="Neck Slot"then itemlocation="neck"elseif b5=="Shoulders Slot"then itemlocation="shoulders"elseif b5=="Back Slot"then itemlocation="back"elseif b5=="Chest Slot"then itemlocation="chest"elseif b5=="Wrists Slot"then itemlocation="wrist"elseif b5=="Hands Slot"then itemlocation="hands"elseif b5=="Waist Slot"then itemlocation="waist"elseif b5=="Legs Slot"then itemlocation="legs"elseif b5=="Feet Slot"then itemlocation="feet"elseif b5=="Fingers Slot"then itemlocation="fingers"elseif b5=="Trinkets Slot"then itemlocation="trinkets"elseif b5=="Main Hand Slot"then itemlocation="mainhand"elseif b5=="Shield Slot"then itemlocation="shield"elseif b5=="Ranged Slot"then itemlocation="ranged"elseif b5=="Relic Slot"then itemlocation="relic"elseif b5=="Two Hand Slot"then itemlocation="twohand"elseif b5=="One Hand Slot"then itemlocation="onehanders"elseif b5=="Held In Offhand"then itemlocation="heldoffhand"elseif b5=="Offhand Weapon"then itemlocation="offhandweapon"end;WebDKP_Options["ItemLocMult"][itemlocation]=U end;function WebDKP_AnnounceDKPByClass(class,b7)nameEn=WebDKP.translations.CLASS_LOCALIZED_TO_ENG_MAP[class]if nameEn==nil then return end;WebDKP_AnnounceDKPSortedList({[string.lower(nameEn)]=class},b7)end;function WebDKP_AnnounceDKPSortedList(b8,b7)local P=WebDKP_GetTableid()if b8==nil then b8={}end;local b9={}for E,F in pairs(WebDKP_DkpTable)do if type(F)=="table"then local Q=E;local R=F["class"]local S=WebDKP_GetDKP(Q,P)if S~=nil then local T=floor((S-1)/WebDKP_TierInterval)if S==0 then T=0 end;if WebDKP_PassesWhisperFilter(Q,R,S,T,b7,b8)then tinsert(b9,{Q,R,S,T})end end end end;table.sort(b9,function(aQ,aR)if aQ and aR then if aQ[3]==aR[3]then return aQ[1]>=aR[1]else return aQ[3]<=aR[3]end end end)local ba=WebDKP_GetTellLocation()for E,F in pairs(b8)do WebDKP_SendAnnouncement("公布职业: "..F.." 的当前DKP",ba)end;WebDKP_SendAnnouncement("----------------------",ba)for E,F in pairs(b9)do if type(F)=="table"then if F[1]~=nil and F[2]~=nil and F[3]~=nil then local bb=F[3].." :"..F[1].." ( "..F[2].." ) "WebDKP_SendAnnouncement(bb,ba)end end end end;do local bc,bd,be,bf,bg;local function bh()bc=CreateFrame("Frame","DBMUpdateReminder",UIParent)bc:SetFrameStrata("FULLSCREEN_DIALOG")bc:SetWidth(430)bc:SetHeight(140)bc:SetPoint("TOP",0,-230)bc:SetBackdrop({bgFile="Interface\\DialogFrame\\UI-DialogBox-Background",edgeFile="Interface\\DialogFrame\\UI-DialogBox-Border",tile=true,tileSize=32,edgeSize=32,insets={left=11,right=12,top=12,bottom=11}})bd=bc:CreateFontString(nil,"ARTWORK","GameFontNormal")bd:SetWidth(410)bd:SetHeight(0)bd:SetPoint("TOP",0,-16)bf=CreateFrame("EditBox",nil,bc)do local bi=bf:CreateTexture(nil,"BACKGROUND")local bj=bf:CreateTexture(nil,"BACKGROUND")local bk=bf:CreateTexture(nil,"BACKGROUND")bi:SetTexture(130959)bi:SetHeight(32)bi:SetWidth(32)bi:SetPoint("LEFT",-14,0)bi:SetTexCoord(0,0.125,0,1)bj:SetTexture(130960)bj:SetHeight(32)bj:SetWidth(32)bj:SetPoint("RIGHT",6,0)bj:SetTexCoord(0.875,1,0,1)bk:SetTexture(130960)bk:SetHeight(32)bk:SetWidth(1)bk:SetPoint("LEFT",bi,"RIGHT")bk:SetPoint("RIGHT",bj,"LEFT")bk:SetTexCoord(0,0.9375,0,1)end;bf:SetHeight(32)bf:SetWidth(250)bf:SetPoint("TOP",bd,"BOTTOM",0,-4)bf:SetFontObject("GameFontHighlight")bf:SetTextInsets(0,0,0,1)bf:SetFocus()bf:SetText(bg)bf:HighlightText()bf:SetScript("OnTextChanged",function(self)bf:SetText(bg)bf:HighlightText()end)be=bc:CreateFontString(nil,"ARTWORK","GameFontNormal")be:SetWidth(410)be:SetHeight(0)be:SetPoint("TOP",bf,"BOTTOM",0,0)local ax=CreateFrame("Button",nil,bc)ax:SetHeight(24)ax:SetWidth(75)ax:SetPoint("BOTTOM",0,13)ax:SetNormalFontObject("GameFontNormal")ax:SetHighlightFontObject("GameFontHighlight")ax:SetNormalTexture(ax:CreateTexture(nil,nil,"UIPanelButtonUpTexture"))ax:SetPushedTexture(ax:CreateTexture(nil,nil,"UIPanelButtonDownTexture"))ax:SetHighlightTexture(ax:CreateTexture(nil,nil,"UIPanelButtonHighlightTexture"))ax:SetText(OKAY)ax:SetScript("OnClick",function(self)bc:Hide()end)end;function WebDKP_ShowOpenWebsite(self)bg=_G["WebDKP_Frame".."Website".."Label"]:GetText()if not bc then bh()else bf:SetText(bg)bf:HighlightText()end;bc:Show()bd:SetText(text)be:SetText("按下 "..(IsMacClient()and"Cmd-C"or"Ctrl-C").."复制链接到剪切板。")end end
