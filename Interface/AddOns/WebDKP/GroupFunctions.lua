function WebDKP_UpdateTable()local a={}for b,c in pairs(WebDKP_DkpTableToShow)do if type(c)=="table"then if c[1]~=nil and c[2]~=nil and c[3]~=nil and c[4]~=nil then tinsert(a,{c[1],c[2],c[3],c[4],c[5],c[6]})end end end;table.sort(a,function(d,e)if d and e then if d==nil then return 1>0 elseif e==nil then return 1<0 end;if WebDKP_LogSort["way"]==1 then if d[WebDKP_LogSort["curr"]]==e[WebDKP_LogSort["curr"]]then return d[1]>e[1]else return d[WebDKP_LogSort["curr"]]>e[WebDKP_LogSort["curr"]]end else if d[WebDKP_LogSort["curr"]]==e[WebDKP_LogSort["curr"]]then return d[1]<e[1]else return d[WebDKP_LogSort["curr"]]<e[WebDKP_LogSort["curr"]]end end end end)local f=getn(a)local g=FauxScrollFrame_GetOffset(WebDKP_FrameScrollFrame)FauxScrollFrame_Update(WebDKP_FrameScrollFrame,f,22,20)for h=1,22,1 do local i=getglobal("WebDKP_FrameLine"..h)local j=getglobal("WebDKP_FrameLine"..h.."Name")local k=getglobal("WebDKP_FrameLine"..h.."Class")local l=getglobal("WebDKP_FrameLine"..h.."DKP")local m=getglobal("WebDKP_FrameLine"..h.."Rank")local n=h+FauxScrollFrame_GetOffset(WebDKP_FrameScrollFrame)if n<=f then local o=a[n][1]i:Show()j:SetText(a[n][1])k:SetText(a[n][2])local p=a[n][2]p=string.upper(p)p=string.gsub(p," ","")if RAID_CLASS_COLORS[p]~=nil then k:SetTextColor(RAID_CLASS_COLORS[p]["r"],RAID_CLASS_COLORS[p]["g"],RAID_CLASS_COLORS[p]["b"])j:SetTextColor(RAID_CLASS_COLORS[p]["r"],RAID_CLASS_COLORS[p]["g"],RAID_CLASS_COLORS[p]["b"])end;l:SetText(a[n][3])m:SetText(a[n][5])if not WebDKP_DkpTable[o]["Selected"]then getglobal("WebDKP_FrameLine"..h.."Background"):SetVertexColor(0,0,0,0)else getglobal("WebDKP_FrameLine"..h.."Background"):SetVertexColor(0.1,0.1,0.9,0.8)end else i:Hide()end end end;function WebDKP_UpdateTableToShow()GuildRoster()WebDKP_CleanupTable()tableid=WebDKP_GetTableid()local tableid=WebDKP_GetTableid()local q=0;WebDKP_DkpTableToShow={}for b,c in pairs(WebDKP_DkpTable)do if type(c)=="table"then local o=b;local r=c["class"]local s=WebDKP_GetDKP(o,tableid)local t=c["ep_"..tableid]if t==nil or t==0 then t=0;WebDKP_DkpTable[o]["ep_"..tableid]=0 end;local u=WebDKP_DkpTable[o]["gp_"..tableid]if u==nil then u=1;WebDKP_DkpTable[o]["gp_"..tableid]=1 end;local v=floor((s-1)/WebDKP_TierInterval)local w=c["standby"]if s==0 then v=0 end;playerRank="PUG"playerIndex=50;for x=1,GetNumGuildMembers(true)do local y,z,rankindex,_,_,_,_,_,A=GetGuildRosterInfo(x)q=strfind(y,'-')if q~=nil then local B=strsub(y,0,q-1)y=B end;if y==o or string.find(y,o.."-".."(.+)")then playerRank=z;playerIndex=rankindex;x=GetNumGuildMembers(true)+10 end end;if WebDKP_ShouldDisplay(o,r,s,v,w)then tinsert(WebDKP_DkpTableToShow,{o,r,s,v,playerRank,playerIndex,t,u})else WebDKP_DkpTable[o]["Selected"]=false end end end;for C,D in pairs(WebDKP_PlayersInGroup)do if type(D)=="table"then local o=D["name"]if o~=nil then if WebDKP_DkpTable[o]==nil then local r=D["class"]local s=0;local v=0;local t=0;local u=1;WebDKP_MakeSureInTable(o,tableid,r,s)playerRank="PUG"playerIndex=50;for x=1,GetNumGuildMembers(true)do playerRank="PUG"playerIndex=50;local y,z=GetGuildRosterInfo(x)if y==o or string.find(y,o.."-".."(.+)")then playerRank=z;playerIndex=rankindex;x=GetNumGuildMembers(true)+10 end end;if WebDKP_ShouldDisplay(o,r,s,v)then tinsert(WebDKP_DkpTableToShow,{o,r,s,v,playerRank,playerIndex,t,u})else WebDKP_DkpTable[o]["Selected"]=false end end end end end end;function WebDKP_UpdatePlayersInGroup()local E=GetNumGroupMembers()local F=GetNumSubgroupMembers()local G=WebDKP_InBattleground()WebDKP_PlayersInGroup={}if E>0 and G==false then local H,I,J;for h=1,E do H,_,_,_,I,_,_,_,_=GetRaidRosterInfo(h)WebDKP_PlayersInGroup[h]={["name"]=H,["class"]=I}end elseif E==0 and F>0 and G==false then local H,I,J,playerHandle;for h=1,F do playerHandle="party"..h;H=UnitName(playerHandle)I=UnitClass(playerHandle)WebDKP_PlayersInGroup[h]={["name"]=H,["class"]=I}end;WebDKP_PlayersInGroup[F+1]={["name"]=UnitName("player"),["class"]=UnitClass("player")}else WebDKP_PlayersInGroup[0]={["name"]=UnitName("player"),["class"]=UnitClass("player")}end end;function WebDKP_InBattleground()local K,L,M,N,O;for h=1,10 do K,L,M,N,O,teamSize=GetBattlefieldStatus(h)if K=="active"then return true end end;return false end;function WebDKP_AllGroupSelected()local H,I;local E=GetNumGroupMembers()local F=GetNumSubgroupMembers()if E>0 then for h=1,E do H,_,_,_,_,_,_,_,_=GetRaidRosterInfo(h)if not WebDKP_DkpTable[H]["Selected"]then return false end end;return true elseif F>0 then for h=1,F do playerHandle="party"..h;H=UnitName(playerHandle)if not WebDKP_DkpTable[H]["Selected"]then return false end end;if not WebDKP_DkpTable[UnitName("player")]["Selected"]then return false end;return true end;return false end;function WebDKP_CleanupTable()for b,c in pairs(WebDKP_DkpTable)do if type(c)=="table"then local o=b;local P=c["cantrim"]local Q=WebDKP_PlayerInGroup(o)if P==nil then P=false end;local R=WebDKP_DkpTable[o]["standby"]if P==false and R==0 then local S=WebDKP_PlayerHasDKP(o)if S==false then P=true end end;if WebDKP_DkpTable[o]["Selected"]~=nil then P=false end;if P==true and Q==false and WebDKP_Options["EPGPEnabled"]==0 then WebDKP_DkpTable[o]=nil end end end end;function WebDKP_ShouldDisplay(H,I,T,U,R)I=WebDKP.translations.CLASS_LOCALIZED_TO_ENG_MAP[I]local V=0;local W=0;if WebDKP_DkpTable[H]["standby"]==nil then WebDKP_DkpTable[H]["standby"]=0 end;if H=="Unknown"then return false end;if WebDKP_Filters[I]==0 then return false end;if WebDKP_Filters["Standby1"]==1 and R==1 then return true end;if WebDKP_Filters["Group"]==1 and WebDKP_PlayerInGroup(H)==false then return false end;if WebDKP_Filters["Standby2"]==1 and R==0 then return false end;for x=1,GetNumGuildMembers(true)do local y,_,_,_,_,_,_,_,A=GetGuildRosterInfo(x)local q=strfind(y,'-')local X=strsub(y,0,q-1)y=X;if H==y or string.find(y,H.."-".."(.+)")then if A then W=1 end;V=1;x=GetNumGuildMembers()+100 end end;if WebDKP_Options["LimitAlts2"]==1 then if WebDKP_PlayerInGroup(H)==false and WebDKP_Alts[H]~=nil then return false end end;if WebDKP_Options["LimitAlts"]==1 and WebDKP_Alts[H]~=nil then return false end;if WebDKP_Options["LimitGuild"]==1 then if V==0 then return false end end;if WebDKP_Options["LimitGuildOnline"]==1 then if W==0 then return false end end;classcompare=UnitClass(H)if I~=classcompare and classcompare~=nil then WebDKP_DkpTable[H]["class"]=classcompare end;return true end;function WebDKP_GetGuildRank(o)local playerRank="PUG"local playerIndex=50;for x=1,GetNumGuildMembers(true)do local y,z=GetGuildRosterInfo(x)if y==o or string.find(y,o.."-".."(.+)")then playerRank=z;return playerRank end end;return playerRank end
